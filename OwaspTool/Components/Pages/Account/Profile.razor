@page "/account/profile"
@using System.Security.Claims
@using AuthLibrary.Areas.Auth.Models
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using MudBlazor
@attribute [Authorize]

@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IUserWebAppRepository UserWebAppRepository
@inject IDialogService DialogService

<PageTitle>Profile</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-16 mb-16">

    <MudPaper Elevation="4" Class="py-2 px-2">

        <MudStack Spacing="0">

            <MudButton Variant="Variant.Text"
                       OnClick="@ToggleProfileExpanded"
                       Color="Color.Primary">
                @(ProfileExpanded ? "Hide your profile information" : "View your profile information")
            </MudButton>

            <MudCollapse Expanded="ProfileExpanded">

                <MudText Typo="Typo.h4" Color="Color.Primary" Class="mb-2">Profile</MudText>

                <MudText Typo="Typo.body1"><b>First Name:</b> @FirstName</MudText>
                <MudText Typo="Typo.body1"><b>Last Name:</b> @LastName</MudText>
                <MudText Typo="Typo.body1" Class="mb-5"><b>Email:</b> @Email</MudText>

                <div class="section-divider-profile"></div>

                <div class="mt-4 mb-4">
                    <MudButton Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Key"
                               OnClick="@ShowChangePassword">
                        Change Password
                    </MudButton>
                </div>

                @if (ShowPasswordFields)
                {
                    <MudTextField @bind-Value="CurrentPassword"
                                  Label="Current Password"
                                  InputType="InputType.Password"
                                  Required="true"
                                  For="@(() => CurrentPassword)" />

                    <MudTextField @bind-Value="NewPassword"
                                  Label="New Password"
                                  InputType="InputType.Password"
                                  Required="true"
                                  For="@(() => NewPassword)" />

                    <MudTextField @bind-Value="ConfirmPassword"
                                  Label="Confirm New Password"
                                  InputType="InputType.Password"
                                  Required="true"
                                  Validation="@((Func<string, string>)(v => v == NewPassword ? null : "Passwords do not match"))" />

                    <MudButton Class="mt-4"
                               OnClick="@ChangePassword"
                               Color="Color.Primary"
                               Variant="Variant.Filled">
                        Submit New Password
                    </MudButton>
                }

            </MudCollapse>

        </MudStack>

    </MudPaper>

    <MudPaper Elevation="4" Class="py-2 px-2 mt-4">
        <MudStack Spacing="0">
            <MudButton Variant="Variant.Text"
                       OnClick="@ToggleAppExpanded"
                       Color="Color.Primary">
                @(AppExpanded ? "Hide your app information" : "View your app information")
            </MudButton>
            <MudCollapse Expanded="AppExpanded">
                <MudText Typo="Typo.h4" Color="Color.Primary" Class="mb-2">Your applications</MudText>

                @if (UserApps is null)
                {
                    <MudProgressCircular Indeterminate="true" />
                }
                else if (!UserApps.Any())
                {
                    <MudText Typo="Typo.body1">You haven't added any applications yet.</MudText>
                }
                else
                {
                    <MudTable Items="UserApps" Dense="true" Hover="true" Class="mb-5">
                        <HeaderContent>
                            <MudTh>Web application name</MudTh>
                            <MudTh>Security level</MudTh>
                            <MudTh>Actions</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>@context.Name</MudTd>
                            <MudTd>@(string.IsNullOrWhiteSpace(context.LevelLabel) ? context.LevelAcronym : context.LevelLabel)</MudTd>
                            <MudTd>
                                <MudIconButton 
                                    Href="@($"/survey/{context.UserWebAppID}")" 
                                    Icon="@Icons.Material.Filled.QuestionAnswer" 
                                    Color="Color.Secondary"
                                    Class="me-2"
                                    Title="Complete questionnaire">
                                </MudIconButton>

                                @* Show requirements link only if survey completed *@
                                @if (context.IsSurveyCompleted)
                                {
                                    <MudIconButton 
                                        Href="@($"/survey/{context.UserWebAppID}/requirements")"
                                        Icon="@Icons.Material.Filled.ListAlt"
                                        Color="Color.Secondary"
                                        Class="me-2"
                                        Title="View requirements" />
                                }

                                <MudIconButton 
                                    Color="Color.Error" 
                                    Icon="@Icons.Material.Filled.DeleteForever" 
                                    OnClick="@(() => ConfirmDelete(context.UserWebAppID))"
                                    Variant="Variant.Filled"
                                    Title="Delete">
                                </MudIconButton>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                    <div class="section-divider-profile"></div>
                    <MudText Typo="Typo.body1" Class="mt-4"><MudLink Href="/web-application-registry">Click here</MudLink> to add a new application.</MudText>
                }
            </MudCollapse>
        </MudStack>
    </MudPaper>

</MudContainer>

@code {
    private string FirstName = "";
    private string LastName = "";
    private string Email = "";

    private bool ProfileExpanded = false;
    private bool AppExpanded = false;
    private bool ShowPasswordFields = false;

    private string CurrentPassword = "";
    private string NewPassword = "";
    private string ConfirmPassword = "";

    private string ChangePasswordError = "";

    private ApplicationUser? UserEntity;
    private List<UserWebAppDTO>? UserApps;

    protected override async Task OnInitializedAsync()
    {
        var state = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = state.User;

        FirstName = user.FindFirst("Name")?.Value ?? "";
        LastName = user.FindFirst("Surname")?.Value ?? "";
        Email = user.FindFirst(ClaimTypes.Email)?.Value ?? "";

        UserEntity = await UserManager.GetUserAsync(user);

        if (!string.IsNullOrWhiteSpace(Email))
        {
            UserApps = await UserWebAppRepository.GetAllByUserAsync(Email);

            // Determine completed flag per app (sequential to avoid DbContext conflicts)
            foreach (var uwa in UserApps)
            {
                uwa.IsSurveyCompleted = await UserWebAppRepository.IsSurveyCompletedAsync(uwa.UserWebAppID);
            }
        }
        else
        {
            UserApps = new List<UserWebAppDTO>();
        }
    }

    private void ToggleProfileExpanded() => ProfileExpanded = !ProfileExpanded;
    private void ToggleAppExpanded() => AppExpanded = !AppExpanded;

    private void ShowChangePassword() => ShowPasswordFields = true;

    private async Task ChangePassword()
    {
        var state = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = await UserManager.GetUserAsync(state.User);

        var result = await UserManager.ChangePasswordAsync(user, CurrentPassword, NewPassword);

        if (result.Succeeded)
        {
            Navigation.NavigateTo("/account/password-changed", true);
            return;
        }

        foreach (var err in result.Errors)
            ChangePasswordError = err.Description;
    }

    private async Task ConfirmDelete(int userWebAppId)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Confirm Delete",
            (MarkupString)$"Are you sure you want to delete this application?<br /> If you have already completed the questionnaire, or if you have provided any responses, those data will also be permanently deleted. <br /> <b>This action cannot be undone.</b>",
            yesText: "Yes",
            noText: "Cancel",
            options: new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.ExtraSmall }
        );

        if (result == true)
        {
            await DeleteConfirmed(userWebAppId);
        }
    }

    private async Task DeleteConfirmed(int userWebAppId)
    {
        try
        {
            if (string.IsNullOrWhiteSpace(Email))
            {
                Snackbar.Add("Unable to determine user email for deletion.", Severity.Error);
                return;
            }

            await UserWebAppRepository.DeleteAsync(userWebAppId, Email);

            // reload user apps and completion flags
            UserApps = await UserWebAppRepository.GetAllByUserAsync(Email);
            foreach (var uwa in UserApps)
            {
                uwa.IsSurveyCompleted = await UserWebAppRepository.IsSurveyCompletedAsync(uwa.UserWebAppID);
            }

            Snackbar.Add("Application deleted", Severity.Success);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Delete failed: {ex.Message}", Severity.Error);
        }
    }
}
