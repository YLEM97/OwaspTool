@using MudBlazor
@using System.Net.Http.Json
@using System.Text.Json
@using Markdig
@inherits ComponentBase

<MudDialog>
    <DialogContent>
        <MudText Typo="Typo.h6" Class="mb-1">
            AI Help — requirement @RequirementNumber
        </MudText>
        <MudText Typo="Typo.body2" Class="mb-2">@RequirementText</MudText>

        <MudPaper Class="p-2 mb-2" Style="max-height:320px; overflow:auto;">
            @foreach (var msg in Messages)
            {
                <div class="mb-2">
                    <MudText Typo="Typo.caption" Color="@(msg.IsUser? Color.Primary: Color.Secondary)">
                        @(msg.IsUser ? "You" : "AI")
                    </MudText>

                    <div class="mud-typography mud-typography-body2">
                        @((MarkupString)msg.HtmlText)
                    </div>
                </div>
            }

            @if (IsThinking)
            {
                <div class="d-flex align-center">
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="me-2" />
                    <MudText Typo="Typo.caption" Color="Color.Info">AI is thinking...</MudText>
                </div>
            }
        </MudPaper>

        <MudTextField @bind-Value="UserInput"
                      Lines="3"
                      Placeholder="Ask how to implement, request suggestions, clarifications..."
                      Adornment="Adornment.End"
                      AdornmentIcon="@Icons.Material.Filled.Send"
                      OnAdornmentClick="SendAiQuestion"
                      Disabled="IsThinking"
                      Immediate="true"
                      Class="w-100" />
    </DialogContent>
</MudDialog>

@code {
    [Parameter] public string RequirementNumber { get; set; } = string.Empty;
    [Parameter] public string RequirementText { get; set; } = string.Empty;

    public class AiMessage
    {
        public bool IsUser { get; set; }
        public string RawText { get; set; } = string.Empty;
        public string HtmlText { get; set; } = string.Empty;
    }

    private List<AiMessage> Messages { get; set; } = new();
    private string UserInput { get; set; } = string.Empty;
    private bool IsThinking { get; set; }

    [Inject] public HttpClient Http { get; set; } = default!;

    protected override void OnInitialized()
    {
        AddMessage(false,
            "You can ask implementation guidance, examples, or clarifications about this requirement.");
    }

    private void AddMessage(bool isUser, string text)
    {
        // se l'AI restituisce già Markdown, lo convertiamo in HTML
        var html = Markdown.ToHtml(text ?? string.Empty);
        Messages.Add(new AiMessage
        {
            IsUser = isUser,
            RawText = text,
            HtmlText = html
        });
    }

    private async Task SendAiQuestion()
    {
        if (string.IsNullOrWhiteSpace(UserInput) || IsThinking)
            return;

        var question = UserInput.Trim();
        UserInput = string.Empty;

        AddMessage(true, question);
        IsThinking = true;
        StateHasChanged();

        try
        {
            var payload = new
            {
                requirementNumber = RequirementNumber,
                requirementText = RequirementText,
                question = question
            };

            var response = await Http.PostAsJsonAsync("/api/ai/requirement-help", payload);
            var answer = await response.Content.ReadAsStringAsync();

            // L'endpoint può restituire testo puro o JSON;
            // se è JSON con un campo "answer", estraiamolo, altrimenti usiamo la stringa intera.
            string answerText;
            try
            {
                using var doc = JsonDocument.Parse(answer);
                if (doc.RootElement.ValueKind == JsonValueKind.Object &&
                    doc.RootElement.TryGetProperty("answer", out var answerProp) &&
                    answerProp.ValueKind == JsonValueKind.String)
                {
                    answerText = answerProp.GetString() ?? string.Empty;
                }
                else
                {
                    answerText = answer;
                }
            }
            catch
            {
                answerText = answer;
            }

            AddMessage(false, answerText);
        }
        catch (Exception ex)
        {
            AddMessage(false, $"Error while contacting AI: {ex.Message}");
        }
        finally
        {
            IsThinking = false;
            StateHasChanged();
        }
    }
}
